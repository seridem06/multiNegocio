<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLATAFORMA_MULTI_NEGOCIO</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', monospace;
            background-color: #b0b0b0;
            color: #00ff00;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 {
            color: #000;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-icon {
            width: 35px;
            height: 35px;
            background: #000;
            border-radius: 50%;
            display: inline-block;
        }

        /* BOTONES */
        .btn {
            background: transparent;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Consolas', monospace;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #00ff00;
            color: #000;
        }

        .btn-primary {
            background: #00ff00;
            color: #000;
            border: 1px solid #00ff00;
        }

        .btn-danger {
            border-color: #ff0000;
            color: #ff0000;
        }

        .btn-danger:hover {
            background: #ff0000;
            color: #fff;
        }

        .btn-dark {
            border-color: #000;
            color: #000;
        }

        .btn-dark:hover {
            background: #eee;
        }

        /* LAYOUT PRINCIPAL */
        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        /* SIDEBAR */
        .sidebar {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 0;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #333;
            font-weight: bold;
        }

        .sistema-list {
            list-style: none;
        }

        .sistema-item {
            padding: 15px;
            border-bottom: 1px solid #222;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sistema-item:hover {
            background: #111;
        }

        .sistema-item.active {
            background: #111;
            border-right: 4px solid #00ff00;
        }

        .delete-sistema {
            color: #ff0000;
            cursor: pointer;
            padding: 5px;
        }

        /* PANEL PRINCIPAL */
        .main-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* CARDS */
        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 20px;
        }

        .card-header {
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* FORMULARIO */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            color: #888;
            font-size: 12px;
        }

        .form-input, .form-select {
            background: #050505;
            border: 1px solid #333;
            color: #00ff00;
            padding: 10px;
            font-family: 'Consolas', monospace;
            text-align: center;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #00ff00;
        }

        .form-input:disabled {
            color: #00ff00;
            font-weight: bold;
        }

        /* TABLA */
        .table-container {
            overflow-x: auto;
            background: #1a1a1a;
            border: 1px solid #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #333;
        }

        th {
            background: #000;
            color: #00ff00;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #222;
        }

        .table-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .icon-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
        }

        .icon-edit { color: #00ff00; }
        .icon-delete { color: #ff0000; }

        /* VISOR JSON */
        .json-viewer {
            background: #1a1a1a;
            border: 1px solid #333;
            height: 400px;
            display: flex;
            flex-direction: column;
        }

        .json-viewer-header {
            background: #000;
            border-bottom: 1px solid #333;
            padding: 10px;
            color: #ffff00;
        }

        .json-viewer-content {
            flex: 1;
            overflow: auto;
            padding: 10px;
        }

        .json-viewer-content pre {
            margin: 0;
            color: #00ff00;
            font-size: 12px;
            font-family: 'Consolas', monospace;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            border: 2px solid #00ff00;
            padding: 30px;
            max-width: 600px;
            width: 90%;
        }

        .modal-header {
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            cursor: pointer;
            font-size: 24px;
            color: #ff0000;
        }

        /* CREATOR */
        .creator-card {
            background: #1a1a1a;
            border: 2px dashed #000;
            padding: 20px;
            margin-bottom: 20px;
        }

        .campo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .campo-tag {
            background: transparent;
            border: 1px solid #00ff00;
            padding: 5px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .campo-tag-delete {
            color: #ff0000;
            cursor: pointer;
        }

        /* TEXTAREA JSON */
        .json-input {
            width: 100%;
            height: 100px;
            background: #000;
            color: #00ff00;
            border: none;
            padding: 10px;
            font-family: 'Consolas', monospace;
            resize: vertical;
            outline: none;
        }

        /* EMPTY STATE */
        .empty-state {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #000;
            min-height: 400px;
        }

        .empty-state h2 {
            color: #000;
        }

        /* SWITCH */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: #555;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #005500;
        }

        input:checked + .slider:before {
            background-color: #00ff00;
            transform: translateX(26px);
        }

        /* ALERTAS */
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 2000;
            display: none;
            animation: slideIn 0.3s;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #00ff00;
            color: #000;
        }

        .alert-error {
            background: #ff0000;
            color: #fff;
        }

        .alert-warning {
            background: #ffff00;
            color: #000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* LOADING */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ff00;
            font-size: 24px;
            z-index: 1001;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>
                <span class="header-icon"></span>
                PLATAFORMA_MULTI_NEGOCIO
            </h1>
            <button class="btn btn-dark" onclick="toggleCreator()">
                <span id="btnCreatorText">CREAR NUEVO NEGOCIO</span>
            </button>
        </div>

        <!-- CREADOR DE SISTEMAS -->
        <div id="creatorSection" class="creator-card hidden">
            <div class="form-grid">
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Nombre del Negocio</label>
                    <input type="text" id="nuevoNombre" class="form-input" placeholder="Ej: FARMACIA">
                </div>
                
                <div class="form-group">
                    <label>CONTROL DE ID</label>
                    <label class="switch">
                        <input type="checkbox" id="idAutomatico" checked>
                        <span class="slider"></span>
                    </label>
                    <span id="idLabel" style="color: #00ff00;">AUTOM√ÅTICO</span>
                </div>
            </div>

            <hr style="border-color: #333; margin: 20px 0;">

            <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); align-items: start;">
                <div class="form-group">
                    <label>Nombre del Campo</label>
                    <input type="text" id="campoLabel" class="form-input" placeholder="Ej: DNI">
                </div>

                <div class="form-group">
                    <label>Tipo de Campo</label>
                    <select id="campoTipo" class="form-select" onchange="updateCampoConfig()">
                        <option value="text">Texto</option>
                        <option value="number">N√∫mero</option>
                        <option value="select">Lista (Select)</option>
                        <option value="date">Fecha</option>
                        <option value="calculated">Calculado (A √ó B)</option>
                        <option value="age">Edad (Auto)</option>
                        <option value="license_status">Estado Licencia</option>
                    </select>
                </div>

                <div id="campoConfig" class="form-group" style="grid-column: span 3;">
                    <!-- Configuraci√≥n din√°mica seg√∫n tipo -->
                </div>
            </div>

            <div style="margin-top: 15px;">
                <button class="btn btn-primary" style="width: 100%;" onclick="agregarCampo()">A√ëADIR CAMPO</button>
            </div>

            <div class="card" style="margin-top: 20px; background: #000;">
                <label style="color: #00ff00; font-size: 12px;">VISTA PREVIA DE CAMPOS:</label>
                <div id="camposPreview" class="campo-preview"></div>
            </div>

            <button class="btn" style="width: 100%; margin-top: 20px;" onclick="guardarSistema()">
                GENERAR SISTEMA COMPLETO
            </button>
        </div>

        <!-- LAYOUT PRINCIPAL -->
        <div class="main-layout">
            <!-- SIDEBAR -->
            <div class="sidebar">
                <div class="sidebar-header">SISTEMAS</div>
                <ul id="sistemasList" class="sistema-list"></ul>
            </div>

            <!-- PANEL PRINCIPAL -->
            <div class="main-panel">
                <div id="emptyState" class="empty-state">
                    <h2>SELECCIONA UN SISTEMA</h2>
                </div>

                <div id="mainContent" class="hidden">
                    <!-- FORMULARIO -->
                    <div class="card">
                        <div class="card-header">
                            <h3 id="sistemaNombre"></h3>
                        </div>
                        <form id="dataForm">
                            <div id="formFields" class="form-grid"></div>
                            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                                <button type="button" class="btn btn-primary" onclick="submitData()">
                                    <span id="btnSubmitText">REGISTRAR</span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- TABLA -->
                    <div class="table-container">
                        <table>
                            <thead id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>

                    <!-- M√ìDULO JSON -->
                    <div class="card" style="border-color: #00ff00;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="color: #00ff00; font-size: 12px;">MODULO_CARGA_JSON (PLANTILLA SIN ID)</span>
                            <button class="btn" onclick="cargarDesdeJson()">CARGAR Y REGISTRAR</button>
                        </div>
                        <textarea id="jsonInput" class="json-input"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISOR JSON -->
        <div class="json-viewer">
            <div class="json-viewer-header">
                LIVE_DATA_STREAM_JSON (TOTAL 2 DECIMALS)
            </div>
            <div class="json-viewer-content">
                <pre id="jsonViewer">[]</pre>
            </div>
        </div>
    </div>

    <!-- ALERTAS -->
    <div id="alert" class="alert"></div>
    <div id="loading" class="loading">‚è≥ PROCESANDO...</div>

    <script>
        // ==================== ESTADO GLOBAL ====================
        let esquemas = JSON.parse(localStorage.getItem('esquemas')) || [];
        let negocioSeleccionado = null;
        let camposTemporales = [];
        let modoEdicion = false;
        let editandoId = null;

        // ==================== INICIALIZACI√ìN ====================
        document.addEventListener('DOMContentLoaded', () => {
            renderSistemas();
            updateIdLabel();
            updateCampoConfig();
            
            // Event listener para el switch de ID
            document.getElementById('idAutomatico').addEventListener('change', updateIdLabel);
        });

        // ==================== FUNCIONES DE UI ====================
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => {
                alert.className = 'alert';
            }, 3000);
        }

        function toggleCreator() {
            const section = document.getElementById('creatorSection');
            const btn = document.getElementById('btnCreatorText');
            
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                btn.textContent = 'CANCELAR';
            } else {
                section.classList.add('hidden');
                btn.textContent = 'CREAR NUEVO NEGOCIO';
                limpiarCreador();
            }
        }

        function updateIdLabel() {
            const checkbox = document.getElementById('idAutomatico');
            const label = document.getElementById('idLabel');
            label.textContent = checkbox.checked ? 'AUTOM√ÅTICO' : 'MANUAL';
        }

        function updateCampoConfig() {
            const tipo = document.getElementById('campoTipo').value;
            const config = document.getElementById('campoConfig');
            
            let html = '';
            
            if (tipo === 'text') {
                html = `
                    <label>M√°ximo de Caracteres</label>
                    <input type="number" id="maxLength" class="form-input" placeholder="Ej: 50">
                `;
            } else if (tipo === 'number') {
                html = `
                    <label>Configuraci√≥n de N√∫mero</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
                        <div>
                            <label style="font-size: 11px; color: #888;">Longitud Total</label>
                            <input type="number" id="numLength" class="form-input" placeholder="8">
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #888;">Decimales</label>
                            <input type="number" id="decimals" class="form-input" value="2">
                        </div>
                        <label style="display: flex; align-items: center; gap: 5px; color: #00ff00; padding: 10px; background: #050505; border: 1px solid #333;">
                            <input type="checkbox" id="isInteger" style="width: auto;"> Solo Enteros
                        </label>
                    </div>
                `;
            } else if (tipo === 'select') {
                html = `
                    <label>Opciones (separadas por coma)</label>
                    <input type="text" id="options" class="form-input" placeholder="Ej: Opci√≥n1, Opci√≥n2, Opci√≥n3">
                `;
            } else if (tipo === 'calculated') {
                html = `
                    <label>Campos a Multiplicar (ingresa el nombre clave)</label>
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: end;">
                        <div>
                            <label style="font-size: 11px; color: #888;">Campo 1 (key)</label>
                            <input type="text" id="field1" class="form-input" placeholder="precio">
                        </div>
                        <span style="color: #00ff00; font-size: 24px; padding-bottom: 10px;">√ó</span>
                        <div>
                            <label style="font-size: 11px; color: #888;">Campo 2 (key)</label>
                            <input type="text" id="field2" class="form-input" placeholder="cantidad">
                        </div>
                    </div>
                    <small style="color: #888; display: block; margin-top: 5px;">
                        üí° El "key" es el nombre del campo en min√∫sculas con guiones bajos. Ej: "Fecha Nacimiento" ‚Üí "fecha_nacimiento"
                    </small>
                `;
            } else if (tipo === 'age') {
                html = `
                    <label>Campo Fuente (Fecha de Nacimiento)</label>
                    <input type="text" id="sourceField" class="form-input" placeholder="Ej: fecha_nacimiento">
                    <small style="color: #888; display: block; margin-top: 5px;">
                        üí° Ingresa el "key" del campo de fecha. Ej: "Fecha Nacimiento" ‚Üí "fecha_nacimiento"
                    </small>
                `;
            } else if (tipo === 'license_status') {
                html = `
                    <label>Campo Fuente (Fecha de Vencimiento)</label>
                    <input type="text" id="sourceField" class="form-input" placeholder="Ej: fecha_vencimiento">
                    <small style="color: #888; display: block; margin-top: 5px;">
                        üí° Ingresa el "key" del campo de fecha. Ej: "Fecha Vencimiento" ‚Üí "fecha_vencimiento"
                    </small>
                `;
            }
            
            config.innerHTML = html;
        }

        // ==================== SISTEMA CREATOR ====================
        function agregarCampo() {
            const label = document.getElementById('campoLabel').value.trim();
            if (!label) {
                showAlert('Ingresa un nombre para el campo', 'error');
                return;
            }
            
            const tipo = document.getElementById('campoTipo').value;
            const key = label.toLowerCase().replace(/ /g, '_');
            
            const campo = { label, key, type: tipo };
            
            // Configuraciones espec√≠ficas seg√∫n tipo
            if (tipo === 'text') {
                campo.maxLength = document.getElementById('maxLength')?.value || '';
            } else if (tipo === 'number') {
                campo.numLength = document.getElementById('numLength')?.value || '';
                campo.decimals = document.getElementById('decimals')?.value || '2';
                campo.isInteger = document.getElementById('isInteger')?.checked || false;
            } else if (tipo === 'select') {
                campo.options = document.getElementById('options')?.value || '';
            } else if (tipo === 'calculated') {
                campo.field1 = document.getElementById('field1')?.value || '';
                campo.field2 = document.getElementById('field2')?.value || '';
            } else if (tipo === 'age' || tipo === 'license_status') {
                campo.sourceField = document.getElementById('sourceField')?.value || '';
            }
            
            camposTemporales.push(campo);
            renderCamposPreview();
            
            // Limpiar campos
            document.getElementById('campoLabel').value = '';
            updateCampoConfig();
        }

        function eliminarCampoPreview(index) {
            camposTemporales.splice(index, 1);
            renderCamposPreview();
        }

        function renderCamposPreview() {
            const container = document.getElementById('camposPreview');
            container.innerHTML = camposTemporales.map((c, i) => `
                <div class="campo-tag">
                    <span>${c.label} [${c.type}]</span>
                    <span class="campo-tag-delete" onclick="eliminarCampoPreview(${i})">‚úï</span>
                </div>
            `).join('');
        }

        function guardarSistema() {
            const nombre = document.getElementById('nuevoNombre').value.trim();
            
            if (!nombre || camposTemporales.length === 0) {
                showAlert('Faltan datos para crear el sistema', 'error');
                return;
            }
            
            const idAutomatico = document.getElementById('idAutomatico').checked;
            
            const nuevoEsquema = {
                nombre,
                config: { idAutomatico },
                campos: [
                    { key: 'id', label: 'ID', type: 'number', locked: idAutomatico, isInteger: true },
                    ...camposTemporales
                ]
            };
            
            esquemas.push(nuevoEsquema);
            guardarEnLocalStorage();
            renderSistemas();
            toggleCreator();
            showAlert('Sistema creado correctamente', 'success');
        }

        function limpiarCreador() {
            document.getElementById('nuevoNombre').value = '';
            document.getElementById('idAutomatico').checked = true;
            camposTemporales = [];
            renderCamposPreview();
            updateIdLabel();
        }

        // ==================== GESTI√ìN DE SISTEMAS ====================
        function renderSistemas() {
            const lista = document.getElementById('sistemasList');
            lista.innerHTML = esquemas.map((esq, index) => `
                <li class="sistema-item ${negocioSeleccionado?.nombre === esq.nombre ? 'active' : ''}" 
                    onclick="seleccionarSistema(${index})">
                    <span>${esq.nombre}</span>
                    <span class="delete-sistema" onclick="event.stopPropagation(); eliminarSistema(${index})">üóëÔ∏è</span>
                </li>
            `).join('');
        }

        function seleccionarSistema(index) {
            negocioSeleccionado = esquemas[index];
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            
            renderFormulario();
            renderTabla();
            renderSistemas();
            generarPlantillaJSON();
            actualizarVisorJSON();
        }

        function eliminarSistema(index) {
            if (!confirm(`¬øSeguro que deseas eliminar "${esquemas[index].nombre}"?`)) return;
            
            const nombreEliminado = esquemas[index].nombre;
            esquemas.splice(index, 1);
            
            // Eliminar datos asociados
            const datos = JSON.parse(localStorage.getItem('datos')) || {};
            delete datos[nombreEliminado];
            localStorage.setItem('datos', JSON.stringify(datos));
            
            guardarEnLocalStorage();
            
            if (negocioSeleccionado?.nombre === nombreEliminado) {
                negocioSeleccionado = null;
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('mainContent').classList.add('hidden');
            }
            
            renderSistemas();
            showAlert('Sistema eliminado', 'success');
        }

        // ==================== FORMULARIO ====================
        function renderFormulario() {
            document.getElementById('sistemaNombre').textContent = negocioSeleccionado.nombre;
            
            const formFields = document.getElementById('formFields');
            const campos = ordenarCampos(negocioSeleccionado.campos);
            
            formFields.innerHTML = campos.map(campo => {
                const disabled = (campo.key === 'id' && negocioSeleccionado.config.idAutomatico) ||
                                 campo.type === 'calculated' || 
                                 campo.type === 'age' || 
                                 campo.type === 'license_status';
                
                if (campo.type === 'select') {
                    return `
                        <div class="form-group">
                            <label>${campo.label}</label>
                            <select name="${campo.key}" class="form-select">
                                <option value="">Selecciona...</option>
                                ${campo.options.split(',').map(opt => `<option value="${opt.trim()}">${opt.trim()}</option>`).join('')}
                            </select>
                        </div>
                    `;
                } else {
                    const type = campo.type === 'date' ? 'date' : 'text';
                    const placeholder = disabled ? 'AUTO' : '';
                    
                    return `
                        <div class="form-group">
                            <label>${campo.label}</label>
                            <input type="${type}" 
                                   name="${campo.key}" 
                                   class="form-input" 
                                   placeholder="${placeholder}"
                                   ${disabled ? 'disabled' : ''}
                                   data-config='${JSON.stringify(campo)}'>
                        </div>
                    `;
                }
            }).join('');
            
            // Agregar listeners para c√°lculos autom√°ticos
            formFields.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', () => {
                    calcularCamposAutomaticos();
                    validarInput(input);
                });
            });
        }

        function validarInput(input) {
            const config = JSON.parse(input.dataset.config || '{}');
            let value = input.value;
            
            // Validar enteros
            if (config.type === 'number' && config.isInteger && value.includes('.')) {
                input.value = value.replace('.', '');
                return;
            }
            
            // Validar decimales
            if (config.type === 'number' && value.includes('.')) {
                const parts = value.split('.');
                if (parts[1] && parts[1].length > 2) {
                    input.value = parseFloat(value).toFixed(2);
                }
            }
            
            // Validar longitud texto
            if (config.type === 'text' && config.maxLength) {
                if (value.length > parseInt(config.maxLength)) {
                    input.value = value.substring(0, config.maxLength);
                }
            }
            
            // Validar longitud n√∫mero
            if (config.type === 'number' && config.numLength) {
                const soloDigitos = value.replace('.', '');
                if (soloDigitos.length > parseInt(config.numLength)) {
                    input.value = value.substring(0, value.length - 1);
                }
            }
        }

        function calcularCamposAutomaticos() {
            const form = document.getElementById('dataForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            negocioSeleccionado.campos.forEach(campo => {
                const input = form.querySelector(`[name="${campo.key}"]`);
                if (!input) return;
                
                // Campo calculado (multiplicaci√≥n)
                if (campo.type === 'calculated' && campo.field1 && campo.field2) {
                    const val1 = parseFloat(data[campo.field1]) || 0;
                    const val2 = parseFloat(data[campo.field2]) || 0;
                    input.value = (val1 * val2).toFixed(2);
                }
                
                // Edad autom√°tica
                if (campo.type === 'age' && campo.sourceField) {
                    // Buscar el valor del campo fuente en el formulario
                    const campoFuente = negocioSeleccionado.campos.find(c => c.key === campo.sourceField);
                    const valorFuente = data[campo.sourceField];
                    
                    if (valorFuente && valorFuente.trim() !== '') {
                        const fechaNac = new Date(valorFuente);
                        const hoy = new Date();
                        
                        // Validar que la fecha sea v√°lida
                        if (!isNaN(fechaNac.getTime())) {
                            let edad = hoy.getFullYear() - fechaNac.getFullYear();
                            const mes = hoy.getMonth() - fechaNac.getMonth();
                            
                            if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNac.getDate())) {
                                edad--;
                            }
                            
                            if (edad >= 0 && edad < 150) {
                                input.value = edad;
                            }
                        }
                    }
                }
                
                // Estado de licencia
                if (campo.type === 'license_status' && campo.sourceField) {
                    const valorFuente = data[campo.sourceField];
                    
                    if (valorFuente && valorFuente.trim() !== '') {
                        const fechaVenc = new Date(valorFuente);
                        const hoy = new Date();
                        
                        if (!isNaN(fechaVenc.getTime())) {
                            const estado = fechaVenc >= hoy ? 'VIGENTE' : 'VENCIDA';
                            input.value = estado;
                            input.style.color = estado === 'VENCIDA' ? '#ff0000' : '#00ff00';
                            input.style.fontWeight = 'bold';
                        }
                    }
                }
            });
        }

        function submitData() {
            const form = document.getElementById('dataForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            // CALCULAR CAMPOS AUTOM√ÅTICOS ANTES DE VALIDAR
            negocioSeleccionado.campos.forEach(campo => {
                // Campo calculado (multiplicaci√≥n)
                if (campo.type === 'calculated' && campo.field1 && campo.field2) {
                    const val1 = parseFloat(data[campo.field1]) || 0;
                    const val2 = parseFloat(data[campo.field2]) || 0;
                    data[campo.key] = (val1 * val2).toFixed(2);
                }
                
                // Edad autom√°tica
                if (campo.type === 'age' && campo.sourceField && data[campo.sourceField]) {
                    const fechaNac = new Date(data[campo.sourceField]);
                    const hoy = new Date();
                    
                    if (!isNaN(fechaNac.getTime())) {
                        let edad = hoy.getFullYear() - fechaNac.getFullYear();
                        const mes = hoy.getMonth() - fechaNac.getMonth();
                        
                        if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNac.getDate())) {
                            edad--;
                        }
                        
                        if (edad >= 0 && edad < 150) {
                            data[campo.key] = edad;
                        }
                    }
                }
                
                // Estado de licencia
                if (campo.type === 'license_status' && campo.sourceField && data[campo.sourceField]) {
                    const fechaVenc = new Date(data[campo.sourceField]);
                    const hoy = new Date();
                    
                    if (!isNaN(fechaVenc.getTime())) {
                        data[campo.key] = fechaVenc >= hoy ? 'VIGENTE' : 'VENCIDA';
                    }
                }
            });
            
            // Validar campos requeridos (excepto calculados)
            const camposRequeridos = negocioSeleccionado.campos.filter(c => {
                if (c.key === 'id' && negocioSeleccionado.config.idAutomatico) return false;
                if (c.type === 'calculated' || c.type === 'age' || c.type === 'license_status') return false;
                return true;
            });
            
            const hayVacios = camposRequeridos.some(c => !data[c.key] || data[c.key].trim() === '');
            
            if (hayVacios) {
                showAlert('Todos los campos son obligatorios', 'warning');
                return;
            }
            
            // Obtener datos existentes
            const allDatos = JSON.parse(localStorage.getItem('datos')) || {};
            const datosSistema = allDatos[negocioSeleccionado.nombre] || [];
            
            // Generar ID autom√°tico si corresponde
            if (negocioSeleccionado.config.idAutomatico || !data.id) {
                const maxId = datosSistema.length > 0 
                    ? Math.max(...datosSistema.map(d => parseInt(d.id) || 0))
                    : 0;
                data.id = maxId + 1;
            }
            
            // Convertir n√∫meros
            negocioSeleccionado.campos.forEach(campo => {
                if (campo.type === 'number' && data[campo.key]) {
                    data[campo.key] = campo.isInteger 
                        ? parseInt(data[campo.key])
                        : parseFloat(data[campo.key]).toFixed(2);
                }
            });
            
            if (modoEdicion) {
                const index = datosSistema.findIndex(d => d.id == editandoId);
                datosSistema[index] = data;
                modoEdicion = false;
                editandoId = null;
                document.getElementById('btnSubmitText').textContent = 'REGISTRAR';
            } else {
                datosSistema.push(data);
            }
            
            allDatos[negocioSeleccionado.nombre] = datosSistema;
            localStorage.setItem('datos', JSON.stringify(allDatos));
            
            form.reset();
            renderTabla();
            actualizarVisorJSON();
            showAlert('Datos guardados correctamente', 'success');
        }

        // ==================== TABLA ====================
        function renderTabla() {
            const allDatos = JSON.parse(localStorage.getItem('datos')) || {};
            const datos = allDatos[negocioSeleccionado.nombre] || [];
            
            // Ordenar por ID
            datos.sort((a, b) => parseInt(a.id) - parseInt(b.id));
            
            // DEBUG: Mostrar datos en consola
            console.log('üìä Datos guardados:', datos);
            console.log('üìã Esquema:', negocioSeleccionado);
            
            const campos = ordenarCampos(negocioSeleccionado.campos);
            
            // Header
            const thead = document.getElementById('tableHead');
            thead.innerHTML = `
                <tr>
                    ${campos.map(c => `<th>${c.label}</th>`).join('')}
                    <th>OPC</th>
                </tr>
            `;
            
            // Body
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = datos.map(row => `
                <tr>
                    ${campos.map(c => {
                        let valor = row[c.key];
                        
                        // Si el valor no existe y es un campo calculado, intentar calcularlo ahora
                        if ((valor === undefined || valor === null || valor === '') && 
                            (c.type === 'age' || c.type === 'calculated' || c.type === 'license_status')) {
                            
                            if (c.type === 'age' && c.sourceField && row[c.sourceField]) {
                                const fechaNac = new Date(row[c.sourceField]);
                                const hoy = new Date();
                                if (!isNaN(fechaNac.getTime())) {
                                    let edad = hoy.getFullYear() - fechaNac.getFullYear();
                                    const mes = hoy.getMonth() - fechaNac.getMonth();
                                    if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNac.getDate())) {
                                        edad--;
                                    }
                                    valor = edad;
                                }
                            }
                            
                            if (c.type === 'calculated' && c.field1 && c.field2) {
                                const val1 = parseFloat(row[c.field1]) || 0;
                                const val2 = parseFloat(row[c.field2]) || 0;
                                valor = (val1 * val2).toFixed(2);
                            }
                            
                            if (c.type === 'license_status' && c.sourceField && row[c.sourceField]) {
                                const fechaVenc = new Date(row[c.sourceField]);
                                const hoy = new Date();
                                if (!isNaN(fechaVenc.getTime())) {
                                    valor = fechaVenc >= hoy ? 'VIGENTE' : 'VENCIDA';
                                }
                            }
                        }
                        
                        if (c.type === 'number' && !c.isInteger && valor !== undefined && valor !== null && valor !== '') {
                            valor = parseFloat(valor).toFixed(2);
                        }
                        if (c.type === 'license_status' && valor === 'VENCIDA') {
                            return `<td style="color: #ff0000; font-weight: bold;">${valor}</td>`;
                        }
                        return `<td>${valor !== undefined && valor !== null ? valor : ''}</td>`;
                    }).join('')}
                    <td class="table-actions">
                        <button class="icon-btn icon-edit" onclick="editarDato(${row.id})">‚úèÔ∏è</button>
                        <button class="icon-btn icon-delete" onclick="eliminarDato(${row.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function editarDato(id) {
            const allDatos = JSON.parse(localStorage.getItem('datos')) || {};
            const datos = allDatos[negocioSeleccionado.nombre] || [];
            const dato = datos.find(d => d.id == id);
            
            if (!dato) return;
            
            const form = document.getElementById('dataForm');
            Object.keys(dato).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) input.value = dato[key];
            });
            
            modoEdicion = true;
            editandoId = id;
            document.getElementById('btnSubmitText').textContent = 'ACTUALIZAR';
            
            // Scroll al formulario
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
        }

        function eliminarDato(id) {
            if (!confirm('¬øEliminar este registro?')) return;
            
            const allDatos = JSON.parse(localStorage.getItem('datos')) || {};
            const datos = allDatos[negocioSeleccionado.nombre] || [];
            
            allDatos[negocioSeleccionado.nombre] = datos.filter(d => d.id != id);
            localStorage.setItem('datos', JSON.stringify(allDatos));
            
            renderTabla();
            actualizarVisorJSON();
            showAlert('Registro eliminado', 'success');
        }

        // ==================== JSON ====================
        function generarPlantillaJSON() {
            const plantilla = {};
            
            negocioSeleccionado.campos.forEach(campo => {
                // Excluir ID y campos calculados
                if (campo.key === 'id' && negocioSeleccionado.config.idAutomatico) return;
                if (campo.type === 'calculated' || campo.type === 'age' || campo.type === 'license_status') return;
                
                if (campo.type === 'number' && !campo.isInteger) {
                    plantilla[campo.key] = "0.00";
                } else if (campo.type === 'number') {
                    plantilla[campo.key] = 0;
                } else {
                    plantilla[campo.key] = "...";
                }
            });
            
            document.getElementById('jsonInput').value = JSON.stringify(plantilla, null, 2);
        }

        function cargarDesdeJson() {
            try {
                const jsonText = document.getElementById('jsonInput').value;
                const data = JSON.parse(jsonText);
                
                // Validar campos
                const camposRequeridos = negocioSeleccionado.campos
                    .filter(c => {
                        if (c.key === 'id' && negocioSeleccionado.config.idAutomatico) return false;
                        if (c.type === 'calculated' || c.type === 'age' || c.type === 'license_status') return false;
                        return true;
                    })
                    .map(c => c.key);
                
                const camposFaltantes = camposRequeridos.filter(c => !data.hasOwnProperty(c));
                
                if (camposFaltantes.length > 0) {
                    showAlert(`Faltan campos: ${camposFaltantes.join(', ')}`, 'warning');
                    return;
                }
                
                // CALCULAR CAMPOS AUTOM√ÅTICOS
                negocioSeleccionado.campos.forEach(campo => {
                    // Campo calculado (multiplicaci√≥n)
                    if (campo.type === 'calculated' && campo.field1 && campo.field2) {
                        const val1 = parseFloat(data[campo.field1]) || 0;
                        const val2 = parseFloat(data[campo.field2]) || 0;
                        data[campo.key] = (val1 * val2).toFixed(2);
                    }
                    
                    // Edad autom√°tica
                    if (campo.type === 'age' && campo.sourceField && data[campo.sourceField]) {
                        const fechaNac = new Date(data[campo.sourceField]);
                        const hoy = new Date();
                        
                        if (!isNaN(fechaNac.getTime())) {
                            let edad = hoy.getFullYear() - fechaNac.getFullYear();
                            const mes = hoy.getMonth() - fechaNac.getMonth();
                            
                            if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNac.getDate())) {
                                edad--;
                            }
                            
                            if (edad >= 0 && edad < 150) {
                                data[campo.key] = edad;
                            }
                        }
                    }
                    
                    // Estado de licencia
                    if (campo.type === 'license_status' && campo.sourceField && data[campo.sourceField]) {
                        const fechaVenc = new Date(data[campo.sourceField]);
                        const hoy = new Date();
                        
                        if (!isNaN(fechaVenc.getTime())) {
                            data[campo.key] = fechaVenc >= hoy ? 'VIGENTE' : 'VENCIDA';
                        }
                    }
                });
                
                // Obtener datos existentes
                const allDatos = JSON.parse(localStorage.getItem('datos')) || {};
                const datosSistema = allDatos[negocioSeleccionado.nombre] || [];
                
                // Generar ID autom√°tico
                if (negocioSeleccionado.config.idAutomatico || !data.id) {
                    const maxId = datosSistema.length > 0 
                        ? Math.max(...datosSistema.map(d => parseInt(d.id) || 0))
                        : 0;
                    data.id = maxId + 1;
                }
                
                // Convertir n√∫meros
                negocioSeleccionado.campos.forEach(campo => {
                    if (campo.type === 'number' && data[campo.key]) {
                        data[campo.key] = campo.isInteger 
                            ? parseInt(data[campo.key])
                            : parseFloat(data[campo.key]).toFixed(2);
                    }
                });
                
                // Guardar
                datosSistema.push(data);
                allDatos[negocioSeleccionado.nombre] = datosSistema;
                localStorage.setItem('datos', JSON.stringify(allDatos));
                
                // Actualizar UI
                renderTabla();
                actualizarVisorJSON();
                showAlert('JSON cargado y registrado correctamente', 'success');
                
            } catch (e) {
                showAlert('JSON inv√°lido: ' + e.message, 'error');
            }
        }

        function actualizarVisorJSON() {
            const allDatos = JSON.parse(localStorage.getItem('datos')) || {};
            const datos = allDatos[negocioSeleccionado?.nombre] || [];
            
            // Formatear decimales
            const datosFormateados = datos.map(d => {
                const nuevo = { ...d };
                negocioSeleccionado?.campos.forEach(c => {
                    if (c.type === 'number' && !c.isInteger && nuevo[c.key]) {
                        nuevo[c.key] = parseFloat(nuevo[c.key]).toFixed(2);
                    }
                });
                return nuevo;
            });
            
            document.getElementById('jsonViewer').textContent = JSON.stringify(datosFormateados, null, 2);
        }

        // ==================== UTILIDADES ====================
        function ordenarCampos(campos) {
            return [...campos].sort((a, b) => a.key === 'id' ? -1 : b.key === 'id' ? 1 : 0);
        }

        function guardarEnLocalStorage() {
            localStorage.setItem('esquemas', JSON.stringify(esquemas));
        }
    </script>
</body>
</html>